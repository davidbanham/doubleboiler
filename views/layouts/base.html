<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
    <meta name="author" content="notbad software">
    <meta name="description" content="When you need it done yesterday">
    <meta property="og:image" content="https://doubleboiler.app/img/ski_lodge.png">
    <meta property="og:description" content="When you need it done yesterday">
    <meta property="og:title" content="{{.Title}}">

    <title>{{.Title}}</title>

    <!-- CSS  -->
    <link rel="stylesheet" href="/css/inter.css">
    <link rel="stylesheet" href="/css/main.css">

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="theme-color" content="#000000">

    <!--  Scripts-->
    <script src="/js/shims.js"></script>
    <script src="/js/luxon.min.js"></script>

    <!-- HTMX -->
    <script src="/js/htmx.min.js"></script>

    <!-- Choices -->
    <link rel="stylesheet" href="/css/choices.min.css">
    <script src="/js/choices.min.js"></script>

  </head>
  <body>
    {{ if flashes .Context }}
    <div id="flashbox">
      {{range flashes .Context}}
      {{ $id := .ID }}
      {{ if eq .ID "" }}
      {{ $id = uniq }}
      {{ end }}
      <div class="{{ if eq .Type 2 }} bg-green-600 {{ else if eq .Type 3}} bg-indigo-600 {{ else }} bg-red-600 {{ end }}" id="{{$id}}">
        <div class="max-w-7xl mx-auto py-3 px-3 sm:px-6 lg:px-8">
          <div class="flex items-center justify-between flex-wrap">
            <div class="w-0 flex-1 flex items-center">
              <span class="flex p-2 rounded-lg {{ if eq .Type 2 }} bg-green-800 {{ else if eq .Type 3}} bg-indigo-800 {{ else }} bg-red-800 {{ end }}">
                <!-- Heroicon name: speakerphone -->
                <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z" />
                </svg>
              </span>
              <p class="ml-3 font-medium text-white truncate">
              <span>
                {{.Text}}
              </span>
              </p>
            </div>
            {{ range .Actions }}
            <div class="order-3 mx-1 mt-2 flex-shrink-0 w-full sm:order-2 sm:mt-0 sm:w-auto">
              <a href="{{.Url}}" class="flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-indigo-600 bg-white hover:bg-indigo-50">
                {{.Text}}
              </a>
            </div>
            {{ end }}
            <div class="order-2 flex-shrink-0 sm:order-3 sm:ml-3">
              <button id="{{$id}}-destroyer" type="button" class="-mr-1 flex p-2 rounded-md hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-white sm:-mr-2">
                <span class="sr-only">Dismiss</span>
                <!-- Heroicon name: x -->
                <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
              <script>
                (function() {
                  document.getElementById('{{$id}}-destroyer').addEventListener('click', function() {
                    document.getElementById('{{$id}}').hidden = true
                    var req = new XMLHttpRequest();
                    req.open('post', '/flashes/{{$id}}/delete');
                    var formData = new FormData();
                    formData.append('csrf', '{{csrf $.Context}}');
                    req.send(formData);
                  });
                })();
              </script>
            </div>
          </div>
        </div>
      </div>
      {{ end }}
    </div>
    {{ end }}
    <div class="min-h-screen flex overflow-hidden">
      {{ block "menu" . }}
      {{ if .Context }}
      <div class="md:hidden" id="sidebar" hidden>
        <div class="fixed inset-0 flex z-40">
          <div class="fixed inset-0">
            <div class="absolute inset-0 bg-gray-600 opacity-75"></div>
          </div>
          <div class="relative flex-1 flex flex-col max-w-xs w-full pt-5 pb-4 bg-gray-800">
            <div class="absolute top-0 right-0 -mr-14 p-1">
              <button class="flex items-center justify-center h-12 w-12 rounded-full focus:outline-none focus:bg-gray-600" aria-label="Close sidebar" onclick="document.getElementById('sidebar').hidden = true">
                <svg class="h-6 w-6 text-white" stroke="currentColor" fill="none" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
            <div class="flex-shrink-0 flex items-center px-4">
              <a href="{{logoLink .Context}}">
                <img class="h-8 w-auto" src="/img/logo_text_white.min.svg" alt="Doubleboiler">
              </a>
            </div>
            <div class="mt-5 flex-1 h-0 overflow-y-auto">
              <nav class="px-2 space-y-1">
                {{ block "menu-items" . }}
                {{ block "orgpicker" . }}
                {{ if (orgsFromContext .Context).Data }}
                {{ $orgPickerID := uniq }}
                <div class="mx-1">
                  <select id="{{$orgPickerID}}" class="choices-picker orgpicker" name="organisationid">
                    {{ range (orgsFromContext .Context).Data }}
                    <option
                        value="{{.ID}}"
                        {{ if eq (activeOrgFromContext $.Context).ID .ID}} selected {{ end }}
                        >{{.Name}}</option>
                    {{ end }}
                  </select>
                  <script>
                    (function(){
                      const elem = document.getElementById('{{$orgPickerID}}');
                      new Choices(elem, {});
                      elem.addEventListener("click", function(e) {
                        var searchParams = new URLSearchParams(window.location.search);
                        searchParams.set('{{.}}', elem.value);
                        window.location.search = searchParams.toString();
                      });
                    })()
                  </script>
                </div>
                {{ end }}
                {{ end }}
                <a href="/welcome" class="group flex items-center px-2 py-2 text-sm leading-5 font-medium text-white rounded-md bg-gray-900 focus:outline-none focus:bg-gray-700 transition ease-in-out duration-150">
                  Dashboard
                </a>
                {{ end }}
              </nav>
            </div>
          </div>
          <div class="flex-shrink-0 w-14">
            <!-- Dummy element to force sidebar to shrink to fit close icon -->
          </div>
        </div>
      </div>

      <!-- Static sidebar for desktop -->
      <div class="hidden md:flex md:flex-shrink-0">
        <div class="flex flex-col w-64">
          <div class="flex flex-col h-0 flex-1">
            <div class="flex items-center h-16 flex-shrink-0 px-4 bg-gray-900">
              <a href="{{logoLink .Context}}">
                <img class="h-8 w-auto" src="/img/logo_text_white.min.svg" alt="Doubleboiler">
              </a>
            </div>
            <div class="flex-1 flex flex-col overflow-y-auto">
              <nav class="flex-1 px-2 py-4 bg-gray-800 space-y-1">
                {{ template "menu-items" . }}
              </nav>
            </div>
          </div>
        </div>
      </div>
      {{ end }}
      {{ end }}
      <div class="flex flex-col w-0 flex-1 overflow-hidden">
        <div class="flex-1 relative overflow-y-auto focus:outline-none">
          {{ block "topbar" . }}
          <div class="print:hidden w-full fixed z-10 top-0 border-t border-b border-gray-200 bg-white flex-1 flex justify-between h-12">
            {{ block "breadcrumbs" . }}
            {{ end }}
            {{ if loggedIn .Context }}
            <div class="print:hidden fixed right-0 h-11 bg-white flex flex-row-reverse gap-2 pr-4">
              <div class="md:hidden flex items-center">
                <button id="sidebar-button" class="py-2 px-2 sm:ml-2 text-gray-500 focus:outline-none focus:bg-gray-100 focus:text-gray-600" aria-label="Open sidebar">
                  <svg class="h-6 w-6" stroke="currentColor" fill="none" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" />
                  </svg>
                </button>
                <script>
                  (function() {
                    document.getElementById('sidebar-button').addEventListener('click', function() {
                      const elem = document.getElementById('sidebar');
                      elem.hidden = !elem.hidden;
                    });
                  })();
                </script>
              </div>
              <div class="flex items-center">
                <!-- Profile dropdown -->
                <div class="ml-3 relative">
                  <div>
                    <button class="max-w-xs flex items-center text-sm rounded-full focus:outline-none focus:shadow-outline" id="user-menu" aria-label="User menu" aria-haspopup="true">
                      <img class="h-8 w-8 rounded-full" src="https://secure.gravatar.com/avatar/{{hash (user .Context).Email }}?s=70&d=mp" alt="">
                    </button>
                    <script>
                      (function() {
                        document.getElementById('user-menu').addEventListener('click', function() {
                          const elem = document.getElementById('user-menu-flyout');
                          elem.hidden = !elem.hidden;
                        });
                      })();
                    </script>
                  </div>
                  <div class="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg" id="user-menu-flyout" hidden>
                    <div class="py-1 rounded-md bg-white shadow-xs text-gray-700 px-4 hover:bg-gray-100 transition ease-in-out duration-150" role="menu" aria-orientation="vertical" aria-labelledby="user-menu">
                      <a href="/users/{{(user $.Context).ID}}" class="block py-2 text-sm" role="menuitem">Your Profile</a>
                      <a href="/logout" class="block py-2 text-sm" role="menuitem">Sign out</a>
                    </div>
                  </div>
                </div>
              </div>
              <div class="sm:block hidden">
                {{ block "topsearch" . }}
                {{ template "searchbox" }}
                {{ end }}
              </div>
            </div>
            {{ end }}
          </div>
          <div class="print:hidden w-full relative h-12">
          </div>
          {{ end }}
          <div class="flex gap-2">
            <main class="bg-white min-h-screen p-4 w-full" tabindex="0">
              {{ block "content" . }}
              {{ end }}
            </main>
            {{ block "context-menu" . }}
            {{ end }}
          </div>
          <footer class="shadow-inner">
            <div class="max-w-7xl mx-auto py-12 px-4 sm:px-6 md:flex md:items-center md:justify-between lg:px-8">
              <div class="mt-8 md:mt-0 md:order-1">
                <div class="text-base text-gray-400">
                  Doubleboiler is (made by) <a class="text-lighten-3" href="https://notbad.software">notbad software</a>
                </div>
                <div class="text-base text-gray-400">
                  <a class="text-lighten-3" href="/eula.pdf">Terms and Conditions</a>
                </div>
                <div class="text-base text-gray-400">
                  <a class="text-lighten-3" href="/privacy_collection_statement.pdf">Privacy Collection Statement</a>
                </div>
              </div>
            </div>
          </footer>

        </div>
      </div>
    </div>

    {{ if isLocal }}
    <script type="text/javascript">
      (function() {
        const connectWs = function(retrigger) {
          var conn = new WebSocket("wss://"+location.host+"/change-watcher");
          conn.onclose = function(evt) {
            connectWs(true);
          };
          conn.onmessage = function(evt) {
            window.location = window.location;
          };
          conn.onopen = function(evt) {
            if (retrigger) {
              window.location = window.location;
            }
          };
        };
        connectWs();
      })();
    </script>
    {{ end }}

  </body>
</html>
